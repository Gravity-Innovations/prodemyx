name: Deploy Backend to Hostinger

on:
  push:
    branches: ["main"]
    paths:
      - 'backend/**'
      - 'prodemyx.sql'
      - '.github/workflows/deploy-backend-hostinger.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 2

    - name: Install sshpass
      run: sudo apt-get update && sudo apt-get install -y sshpass

    - name: Setup MySQL Server
      run: |
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 'bash -s' << 'EOF'
        PASS='Dev@2025'
        set -e
        PASS='Dev@2025'
        echo "========================================="
        echo "Setting up MySQL Server"
        echo "========================================="
        if ! command -v mysql > /dev/null 2>&1; then
          echo "Installing MySQL Server..."
          echo "$PASS" | sudo -S apt-get update
          echo "$PASS" | sudo -S DEBIAN_FRONTEND=noninteractive apt-get install -y mysql-server
          echo "$PASS" | sudo -S systemctl enable mysql
          echo "$PASS" | sudo -S systemctl start mysql
          echo "MySQL installed successfully"
        else
          echo "MySQL already installed"
          echo "$PASS" | sudo -S systemctl start mysql || true
        fi
        echo "Configuring MySQL database..."
        echo "$PASS" | sudo -S mysql -e "CREATE DATABASE IF NOT EXISTS prodemyx;" 2>/dev/null || true
        echo "$PASS" | sudo -S mysql -e "CREATE USER IF NOT EXISTS 'prodemyx_user'@'localhost' IDENTIFIED BY 'ProdemyxSecure2024!';" 2>/dev/null || true
        echo "$PASS" | sudo -S mysql -e "GRANT ALL PRIVILEGES ON prodemyx.* TO 'prodemyx_user'@'localhost';" 2>/dev/null || true
        echo "$PASS" | sudo -S mysql -e "FLUSH PRIVILEGES;" 2>/dev/null || true
        echo "MySQL database configured"
        EOF

    - name: Setup Node.js and PM2
      run: |
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 'bash -s' << 'EOF'
        PASS='Dev@2025'
        set -e
        echo "========================================="
        echo "Setting up Node.js and PM2"
        echo "========================================="
        if ! command -v node > /dev/null 2>&1; then
          echo "Installing Node.js 18.x..."
          curl -fsSL https://deb.nodesource.com/setup_18.x -o /tmp/node_setup.sh
          echo "$PASS" | sudo -S bash /tmp/node_setup.sh
          echo "$PASS" | sudo -S apt-get install -y nodejs
          echo "Node.js installed: $(node -v)"
        else
          echo "Node.js already installed: $(node -v)"
        fi
        if ! command -v pm2 > /dev/null 2>&1; then
          echo "Installing PM2..."
          echo "$PASS" | sudo -S npm install -g pm2
          echo "PM2 installed successfully"
        else
          echo "PM2 already installed"
        fi
        EOF

    - name: Setup Nginx
      run: |
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 'bash -s' << 'EOF'
        PASS='Dev@2025'
        set -e
        echo "========================================="
        echo "Setting up Nginx"
        echo "========================================="
        if ! command -v nginx > /dev/null 2>&1; then
          echo "Installing Nginx..."
          echo "$PASS" | sudo -S apt-get update
          echo "$PASS" | sudo -S apt-get install -y nginx
          echo "$PASS" | sudo -S systemctl enable nginx
          echo "$PASS" | sudo -S systemctl start nginx
          echo "Nginx installed successfully"
        else
          echo "Nginx already installed"
          echo "$PASS" | sudo -S systemctl start nginx || true
        fi
        EOF

    - name: Create backend directory
      run: |
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 "mkdir -p ~/prodemyx/backend"

    - name: Check if database file changed
      id: check_db
      run: |
        if git diff --name-only HEAD^ HEAD | grep -q "prodemyx.sql"; then
          echo "db_changed=true" >> $GITHUB_OUTPUT
        else
          echo "db_changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Import database if SQL file changed
      if: steps.check_db.outputs.db_changed == 'true'
      run: |
        echo "Database file changed, importing..."
        sshpass -p 'Dev@2025' scp -o StrictHostKeyChecking=no prodemyx.sql prodemyxdev@72.61.243.218:/tmp/prodemyx.sql
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 'bash -s' << 'EOF'
        PASS='Dev@2025'
        set -e
        echo "Creating database backup..."
        BACKUP_FILE="/tmp/prodemyx_backup_$(date +%Y%m%d_%H%M%S).sql"
        echo "$PASS" | sudo -S mysqldump prodemyx > "$BACKUP_FILE" 2>/dev/null || echo "No existing data to backup"
        echo "Importing database..."
        echo "$PASS" | sudo -S mysql prodemyx < /tmp/prodemyx.sql
        echo "Database imported successfully!"
        rm -f /tmp/prodemyx.sql
        EOF

    - name: Sync backend folder to Hostinger
      run: |
        sshpass -p 'Dev@2025' rsync -avz --delete \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '.env' \
          --exclude 'logs/*' \
          --exclude '*.log' \
          -e 'ssh -o StrictHostKeyChecking=no' \
          backend/ \
          prodemyxdev@72.61.243.218:~/prodemyx/backend/

    - name: Deploy environment variables
      run: |
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 "cat > ~/prodemyx/backend/.env" << 'ENVEOF'
        PORT=5000
        DB_HOST=localhost
        DB_USER=prodemyx_user
        DB_PASSWORD=ProdemyxSecure2024!
        DB_NAME=prodemyx
        JWT_SECRET=your-secret-key-change-this-in-production
        NODE_ENV=production
        PUBLIC_URL=http://72.61.243.218
        ENVEOF

    - name: Configure Nginx
      run: |
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 'bash -s' << 'EOF'
        set -e
        PASS='Dev@2025'
        echo "Configuring Nginx..."
        
        cat > /tmp/prodemyx-nginx << 'NGINXEOF'
        upstream backend_app {
            server 127.0.0.1:5000;
            keepalive 64;
        }

        server {
            listen 80 default_server;
            listen [::]:80 default_server;
            server_name _;
            
            add_header X-Frame-Options "SAMEORIGIN" always;
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-XSS-Protection "1; mode=block" always;
            
            client_max_body_size 50M;
            
            location /api/api-docs {
                return 301 /api-docs;
            }

            location ^~ /api/ {
                proxy_pass http://backend_app;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
                proxy_read_timeout 300s;
                proxy_connect_timeout 75s;
            }
            
            location /api-docs {
                proxy_pass http://backend_app/api-docs;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_cache_bypass $http_upgrade;
            }

            location /app/ {
                alias /var/www/prodemyx-dashboard/;
                try_files $uri $uri/ /app/index.html;
                index index.html;
            }
            
            location / {
                root /var/www/prodemyx-website;
                try_files $uri $uri/ /index.html;
                index index.html;
            }
            
            location ~ /\. {
                deny all;
                access_log off;
                log_not_found off;
            }
        }
        NGINXEOF
        
        echo "$PASS" | sudo -S cp /tmp/prodemyx-nginx /etc/nginx/sites-available/prodemyx
        echo "$PASS" | sudo -S ln -sf /etc/nginx/sites-available/prodemyx /etc/nginx/sites-enabled/
        echo "$PASS" | sudo -S rm -f /etc/nginx/sites-enabled/default
        echo "$PASS" | sudo -S nginx -t
        echo "$PASS" | sudo -S systemctl reload nginx
        echo "Nginx configured successfully!"
        EOF

    - name: Install dependencies and restart backend
      run: |
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 'bash -s' << 'EOF'
        PASS='Dev@2025'
        set -e
        cd ~/prodemyx/backend
        echo "Installing dependencies..."
        npm install
        
        echo "Managing PM2 process..."
        pm2 delete prodemyx-backend 2>/dev/null || true
        
        echo "Starting backend process..."
        pm2 start server.js --name prodemyx-backend
        pm2 save
        pm2 startup systemd -u $USER --hp $HOME | tail -1 | sudo bash || true
        
        sleep 5
        echo "Backend deployment completed!"
        EOF

    - name: Verify deployment
      run: |
        sshpass -p 'Dev@2025' ssh -o StrictHostKeyChecking=no prodemyxdev@72.61.243.218 'bash -s' << 'EOF'
        PASS='Dev@2025'
        echo "========================================="
        echo "Deployment Verification"
        echo "========================================="
        echo "Checking backend process..."
        pm2 list | grep prodemyx-backend || exit 1
        echo "Checking MySQL..."
        echo "$PASS" | sudo -S systemctl is-active mysql || exit 1
        echo "Checking Nginx..."
        echo "$PASS" | sudo -S systemctl is-active nginx || exit 1
        echo "Testing backend API..."
        sleep 3
        curl -f http://localhost:5000 > /dev/null 2>&1 || echo "Backend warming up..."
        echo "========================================="
        echo "âœ“ Backend deployment successful!"
        echo "========================================="
        EOF
